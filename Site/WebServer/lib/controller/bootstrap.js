var fs=require("fs"),path=require("path"),gui=require("nw.gui"),head=gui.Window.get(this),pkg=require(path.resolve("./","package.json")),configuration=require(path.resolve(path.join("./","lib","config.json"))),config=configuration,win={splash:path.join(".","lib","view","splash.html"),main:path.join(".","lib","view","main.html")},uuid=require("node-uuid");ua=require("universal-analytics"),active=null,process.on("uncaughtexception",function(a){console.dir(a),alert(a.message),"EACCES"===a.code&&alert("Insufficient permissions."),!head.isDevToolsOpen()&&config.dev&&head.showDevTools()}),config.dev&&head.showDevTools();var ganoop=function(){return{send:function(){}}};Object.defineProperties(global,{windows:{enumerable:!0,get:function(){return win}},OS:{enumerable:!0,get:function(){return require("os").platform()}},trigger:{enumerable:!0,writable:!1,configurable:!1,value:function(a,b){win[a].emit(b)}},track:{enumerable:!0,get:function(){return void 0===localStorage.getItem("fid")&&localStorage.setItem("fid",uuid.v4()),configuration.googleanalytics?{event:ganoop,pageview:ganoop}:ua(configuration.googleanalytics,localStorage.getItem("fid"))}},pkg:{enumerable:!0,writable:!1,configurable:!1,value:pkg}});var autoshow=config.main.hasOwnProperty("show")?config.main.show:!0;config.main.hasOwnProperty("show")&&delete config.main.show,config.dev=config.hasOwnProperty("dev")?config.dev:!1,fs.exists(win.splash,function(a){if(a){var b=config.splash;win.splash=gui.Window.open(win.splash,{frame:b.hasOwnProperty("frame")?b.frame:!1,toolbar:config.dev?!0:b.hasOwnProperty("toolbar")?b.toolbar:!1,width:b.width||600,height:b.height||400,transparent:b.hasOwnProperty("transparent")?b.transparent:!0,show_in_taskbar:b.hasOwnProperty("show_in_taskbar")?b.show_in_taskbar:!1,icon:path.resolve(config.icon),frame:config.dev===!0?!0:b.hasOwnProperty("frame")?b.frame:!1,"new-instance":!1})}Object.keys(config.windows||{}).forEach(function(a){var b=config.windows[a];b.show=b.hasOwnProperty("show")?b.show:!0,b.show_in_taskbar=b.hasOwnProperty("show_in_taskbar")?b.show_in_taskbar:!1,b.icon=b.icon||path.resolve(config.icon),b.toolbar=config.dev?!0:b.hasOwnProperty("toolbar")?b.toolbar:!1,b.frame=config.dev?!0:b.hasOwnProperty("frame")?b.frame:!0,b["new-instance"]=!1,win[a]=new gui.Window.open(path.join(".","lib","view",a+".html"),b),b.close&&win[a].on("close",function(){this.hide()})});var b=config.main;win.main=new gui.Window.open(win.main,{show:autoshow,frame:config.dev?!0:b.hasOwnProperty("frame")?b.frame:!0,toolbar:config.dev?!0:b.hasOwnProperty("toolbar")?b.toolbar:!1,width:b.width||pkg.window.width,height:b.height||pkg.window.height,transparent:b.hasOwnProperty("transparent")?b.transparent:!0,show_in_taskbar:b.hasOwnProperty("show_in_taskbar")?b.show_in_taskbar:!0,icon:path.resolve(config.icon),"new-instance":!1}),win.main.on("close",function(){head.close()}),win.main.once("ready",function(){win.main.show(),win.splash instanceof String||win.splash.close(),win.main.focus(),global.track.event("Application","launch","Opened Desktop Application").send(),global.track.pageview("/app/webservers").send()}),win.main.on("loaded",function(){autoshow&&win.main.emit("ready")})}),head.on("close",function(){gui.App.closeAllWindows(),gui.App.quit()}),global.windows.head=head;