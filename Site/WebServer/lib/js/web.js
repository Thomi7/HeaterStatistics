var Converter=require("ansi-to-html"),Growler=require("growler"),UI={server:{create:function(a){ROUTER.createServer(a)},display:function(a,b){if(!document.getElementById(a.id)){$("body").addClass("hasservers");var c=require("fs");$("#servers > div:first-child").before('<div id="'+a.id+'"'+(0==c.existsSync(a.path)?' class="animated '+(a.running?"running":"unavailable")+'"':'class="animated'+(a.running?" running":"")+'"')+'><img src="data:image/gif;base64,R0lGODlhAQABAPAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" class="hint--rounded hint--bottom hint--bounce" data-hint="Latest screenshot. Click to view fullsize image."/><div><div class="hint--bottom hint--bounce hint--rounded" data-hint="Open http://127.0.0.1:'+a.port.toString()+'">'+a.name+"</div><div>"+a.port.toString()+"</div><div>"+a.path+'</div></div><div><div class="hint--left hint--rounded" data-hint="View Server Logs"><div class="icon-menu"></div></div><div class="hint--left hint--rounded" data-hint="Enable Public View"><div class="icon-share"></div></div><div class="hint--left hint--rounded" data-hint="'+(a.running?"Stop":"Start")+' Server"><div class="icon-play"></div></div><div class="hint--left hint--rounded" data-hint="Edit"><div class="icon-pencil"></div></div><div class="hint--left hint--rounded" data-hint="Remove Server"><div class="icon-trash"></div></div></div></div>'),UI.server.listen(),UI.wizard.hide(b),a.running?a.captureScreen():setTimeout(function(){$("#servers > div:first-child").addClass("animated swing"),UI.wizard.reset()},300)}},update:function(a){var b=ROUTER.getServer(a),c=$("#"+a).find("div:nth-child(2) > div");c[0].innerHTML=b.name,c[0].setAttribute("data-hint","Open http://127.0.0.1:"+b.port.toString()),c[1].innerHTML=b.port.toString(),c[2].innerHTML=b.path},start:function(a){var b=ROUTER.getServer(a);svr=$("#"+a),0!==svr.length&&(b.running?(svr.addClass("running"),svr.find("div:last-child > div:nth-child(3)")[0].setAttribute("data-hint","Stop Server")):b.start(function(){svr.addClass("running"),svr.find("div:last-child > div:nth-child(3)")[0].setAttribute("data-hint","Stop Server")}))},stop:function(a){var b=ROUTER.getServer(a);b.running?(b.once("stop",function(){$("#"+a).removeClass("running"),$("#"+a).find("div:last-child > div:nth-child(3)")[0].setAttribute("data-hint","Start Server")}),b.stop()):($("#"+a).removeClass("running"),$("#"+a).find("div:last-child > div:nth-child(3)")[0].setAttribute("data-hint","Start Server"))},listen:function(a){$("#servers > div > img").off("click").on("click",function(a){window.open($(a.currentTarget)[0].getAttribute("src"),"_blank","width=600,height=600,menubar=no,titlebar=no,location=no")}),$("#servers > div > div:nth-child(2) > div:first-child").off("click").on("click",function(a){ROUTER.getServer(a.currentTarget.parentNode.parentNode.id).running&&gui.Shell.openExternal(a.currentTarget.getAttribute("data-hint").replace("Open ",""))}),$("#servers > div > div:last-child > div:first-child").off("click").on("click",function(a){UI.logview.show(a.currentTarget.parentNode.parentNode.id)}),$("#servers > div > div:last-child > div:nth-child(2)").off("click").on("click",function(a){var b=ROUTER.getServer(a.currentTarget.parentNode.parentNode.id);b[b.shared===!1?"share":"unshare"]()}),$("#servers > div > div:last-child > div:nth-child(3)").off("click").on("click",function(a){var b=ROUTER.getServer(a.currentTarget.parentNode.parentNode.id);UI.server[b.running===!0?"stop":"start"](b.id),UI.server.mask(b.id,b.running?"Stopping...":"Starting...")}),$("#servers > div > div:last-child > div:nth-child(4)").off("click").on("click",function(a){var b=ROUTER.getServer(a.currentTarget.parentNode.parentNode.id);UI.editwizard.show(b)}),$("#servers > div > div:last-child > div:last-child").off("click").on("click",function(a){ROUTER.deleteServer(a.currentTarget.parentNode.parentNode.id)}),$("#servers > div").on("click",function(a){if($(a.currentTarget).hasClass("shared")&&a.currentTarget.offsetTop+a.currentTarget.clientHeight+8<a.y){var b=a.currentTarget,c=ROUTER.getServer(b.id).publicUrl;b.clientWidth-67<a.x?(gui.Clipboard.get().set(c),$(b).addClass("highlight"),setTimeout(function(){$(b).removeClass("highlight")},200)):gui.Shell.openExternal(c)}}),a&&a()},mask:function(a,b){$("#mask")[0].innerHTML=b||"...",$("#mask")[0].setAttribute("for",a);var c=$("#"+a)[0];UI.server.cover(c.offsetTop,c.offsetLeft,c.clientWidth,c.clientHeight)},unmask:function(){UI.server.uncover()},cover:function(a,b,c,d){$("#mask").css({top:a+24,left:b+4,width:c+10,height:d+4,"line-height":(d+4).toString()+"px"}),$("#mask").addClass("show")},uncover:function(){$("#mask").removeClass("show")},resizeMask:function(){$("#mask").hasClass("show")&&UI.server.mask($("#mask")[0].getAttribute("for"),$("#mask")[0].innerHTML)},setThumbnail:function(a,b){$("#"+a).find("img:first-child")[0].setAttribute("src",b)},share:function(a){$("#"+a.id).addClass("shared"),$("#"+a.id)[0].setAttribute("shared-url",a.publicUrl),$($("#"+a.id)[0]).find("div.icon-share").parent()[0].setAttribute("data-hint","Disable Public View")},unshare:function(a){$("#"+a.id).removeClass("shared"),$($("#"+a.id)[0]).find("div.icon-share").parent()[0].setAttribute("data-hint","Enable Public View")}},wizard:{hide:function(a){$("#wizard").addClass("bounceOutUp"),setTimeout(function(){$("#wizard").removeClass("bounceInDown show")},800),a&&a()},show:function(){$("#wizard").hasClass("show")||($("#log").hasClass("show")?(UI.logview.hide(),setTimeout(function(){$("#wizard").addClass("bounceInDown show"),$("#wizard").removeClass("bounceOutUp")},500)):($("#wizard").addClass("bounceInDown show"),$("#wizard").removeClass("bounceOutUp")),$("#name").focus())},browseFilepath:function(){$("#choosefile").click()},reset:function(){$("#wizard > input").val(null),ROUTER.getAvailablePort(function(a){$("#port").val(a)}),UI.wizard.button.disable()},valid:function(){return $("#name").val().trim().length>0&&$("#path").val().trim().length>1&&$("#port").val().toString().trim().length>0},prepopulate:function(){var a=require("path").join($("#path").val(),".fenix.json");if(require("fs").existsSync(a)){var b=require(a);$("#name").val(b.name),$("#port").val(parseInt(b.port)),UI.wizard.valid()&&UI.wizard.button.enable()}},button:{enable:function(){$("#wizard > button")[0].removeAttribute("disabled")},disable:function(){$("#wizard > button")[0].setAttribute("disabled",!0)}}},editwizard:{hide:function(a){$("#editwizard").addClass("bounceOutUp"),setTimeout(function(){$("#editwizard").removeClass("bounceInDown show")},800),a&&a()},show:function(a){$("#editwizard").hasClass("show")||($("#epath").val(a.path),$("#eport").val(a.port),$("#ename").val(a.name),$("#eserver").val(a.id),UI.editwizard.button.enable(),$("#log").hasClass("show")?(UI.logview.hide(),setTimeout(function(){$("#editwizard").addClass("bounceInDown show"),$("#editwizard").removeClass("bounceOutUp")},500)):($("#editwizard").addClass("bounceInDown show"),$("#editwizard").removeClass("bounceOutUp")),$("#ename").focus())},browseFilepath:function(){$("#choosefile2").click()},reset:function(){$("#editwizard > input").val(null),ROUTER.getAvailablePort(function(a){$("#eport").val(a)}),UI.editwizard.button.disable()},valid:function(){return $("#ename").val().trim().length>0&&$("#epath").val().trim().length>1&&$("#eport").val().toString().trim().length>0},prepopulate:function(){var a=require("path").join($("#epath").val(),".fenix.json");if(require("fs").existsSync(a)){var b=require(a);$("#ename").val(b.name),$("#eport").val(parseInt(b.port)),UI.wizard.valid()&&UI.wizard.button.enable()}},button:{enable:function(){$("#editwizard > button")[0].removeAttribute("disabled")},disable:function(){$("#editwizard > button")[0].setAttribute("disabled",!0)}}},logview:{converter:new Converter({newline:!0}),currentlog:null,scrollToBottom:function(){var a=$("#log > div")[0];a.scrollTop=a.scrollHeight-$(a).height()},hide:function(){var a=ROUTER.getServer(UI.logview.currentlog);$("#log").addClass("bounceOut"),a.syslog.removeEvent("log"),a.syslog.removeEvent("errormsg"),a.syslog.removeEvent("warn"),setTimeout(function(){$("#log").removeClass("bounceIn show")},800)},show:function(a){if(!$("#log").hasClass("show")){var b=ROUTER.getServer(a);UI.logview.currentlog=a,b.syslog.on("log",function(a){$("#log > div").append('<p class="animated bounceIn">'+UI.logview.clean(a)+"</p>"),UI.logview.scrollToBottom()}),b.syslog.on("errormsg",function(a){$("#log > div").append('<p class="animated bounceIn error">'+UI.logview.clean(a)+"</p>"),UI.logview.scrollToBottom()}),b.syslog.on("warn",function(a){$("#log > div").append('<p class="animated bounceIn warn">'+UI.logview.clean(a)+"</p>"),UI.logview.scrollToBottom()}),$("#log > h3 > span")[0].innerHTML=b.name,$("#log > div").empty();for(var c in b.syslog.syslog)$("#log > div").append('<p class="animated'+(b.syslog.syslog[c].indexOf("WARNING: ")>=0?" warn":"")+(b.syslog.syslog[c].indexOf("ERROR: ")>=0?" error":"")+' "timestamp="'+c+'">'+b.syslog.syslog[c]+"</p>");$("#log").addClass("bounceIn show"),$("#log").removeClass("bounceOut"),global.track.event("Web Server","log","Viewed Log",1).send()}},clean:function(a){return a.replace("\n","<br/>").trim()}},loader:{show:function(a){$("#loader").hasClass("show")||(a&&($("#loader")[0].innerHTML=a),$("#loader").removeClass("bounceOut"),$("#loader").addClass("show"))},hide:function(){$("#loader").hasClass("show")&&($("#loader").addClass("bounceOut"),$("#loader").removeClass("show"),$("#loader")[0].innerHTML="Loading...")}},_growl:{app:new Growler.GrowlApplication("Fenix"),init:function(){UI._growl.app.setNotifications({Status:{displayname:"Fenix Server Status",enabled:!0,icon:require("fs").readFileSync("./lib/icons/fenix.png")}}),UI._growl.app.register(),UI._growl.initialized=!0},initialized:!1,lastmessage:null},lastgrowl:null,notify:function(a){if(UI._growl.initialized||UI._growl.init(),!ROUTER.loading&&"string"!=typeof global.windows.main){a=a||{},"string"==typeof a&&(a={text:a,title:"Fenix Alert"});var b=(a.type||"Status")+JSON.stringify(a);b!==UI._growl.lastmessage?(UI._growl.lastmessage=b,setTimeout(function(){UI._growl.lastmessage=null},300),UI._growl.app.sendNotification(a.type||"Status",a)):console.log("Duplicate notification error:",a.type||"Status",a)}},updateAvailable:function(){$("BODY").addClass("updateavailable")}};UI._growl.init(),window.onresize=function(){UI.server.resizeMask()};var Syslog=Utility.extend({constructor:function(a){a=a||{},Syslog.super.constructor.call(this,a),Object.defineProperties(this,{syslog:{enumerable:!1,writable:!0,configurable:!1,value:{}},prelog:{enumerable:!1,writable:!1,configurable:!1,value:function(a){var b=null;switch(typeof a){case"function":b="[Function]";break;case"object":b=JSON.stringify(a,null,2);break;default:b=a.toString()}return b}},timestamp:{enumerable:!1,get:function(){var a=new Date,b=[a.getMonth()+1,a.getDate(),a.getFullYear()],c=[a.getHours(),a.getMinutes(),a.getSeconds()],d=c[0]<12?"AM":"PM";c[0]=c[0]<12?c[0]:c[0]-12,c[0]=c[0]||12;for(var e=1;3>e;e++)c[e]<10&&(c[e]="0"+c[e]);return b.join("/")+" "+c.join(":")+" "+d}}})},log:function(a){a=this.prelog("["+this.timestamp+"] "+a),this.syslog[+new Date]=a,this.emit("log",a)},error:function(a){a=this.prelog("["+this.timestamp+"] ERROR: "+a),this.syslog[+new Date]=a,this.emit("errormsg",a)},warn:function(a){a=this.prelog("["+this.timestamp+"] WARNING: "+a),this.syslog[+new Date]=a,this.emit("warn",a)}}),Server=Utility.extend({constructor:function(a){a=a||{},Server.super.constructor.call(this,a),Object.defineProperties(this,{id:{enumerable:!0,writable:!0,configurable:!1,value:a.id||null},name:{enumerable:!0,writable:!0,configurable:!1,value:a.name},domain:{enumerable:!0,writable:!0,configurable:!1,value:a.domain||null},port:{enumerable:!0,writable:!0,configurable:!1,value:a.port},_url:{enumerable:!1,writable:!0,configurable:!1,value:null},tunnel:{enumerable:!1,writable:!0,configurable:!1,value:null},publicUrl:{enumerable:!1,get:function(){return this._url}},shared:{enumerable:!1,get:function(){return null!==this._url}},_screenshot:{enumerable:!1,writable:!0,configurable:!1,value:null},screenshot:{enumerable:!0,get:function(){return this._screenshot},set:function(a){this._screenshot=null==a?null:(a||"").toString().trim().length>0?a:null,null!==a&&(a||"").toString().trim().length>0&&(this.syslog.log("Screenshot captured."),this.emit("screencapture",this))}},computer:{enumerable:!1,writable:!0,configurable:!1,value:null},cfg_paths:{enumerable:!0,configurable:!1,writable:!1,value:a.path||{}},syslog:{enumerable:!1,configurable:!1,writable:!0,value:new Syslog},paths:{enumerable:!1,writable:!0,configurable:!0,value:{}},path:{enumerable:!0,get:function(){return this.paths[this.MAC]||""},set:function(a){var b=this.path,c=this;this.paths[this.MAC]=a,b!==a&&this.stop(function(){c.updateServer()}),this.emit("pathchange",{mac:this.MAC,oldValue:b,newValue:a})}},portConflicts:{enumerable:!1,writable:!0,configurable:!1,value:[]},MAC:{enumerable:!1,writable:!0,configurable:!1,value:null},running:{enumerable:!0,writable:!0,configurable:!1,value:!1},starting:{enumerable:!0,writable:!0,configurable:!1,value:!1},stopping:{enumerable:!0,writable:!0,configurable:!1,value:!1},initialized:{enumerable:!1,writable:!0,configurable:!1,value:!1},_http:{enumerable:!1,writable:!0,configurable:!1,value:null},http:{enumerable:!1,get:function(){return null==this._http&&this.updateServer(),this._http}},assistingstart:{enumerable:!1,writable:!0,configurable:!1,value:!1},sockets:{enumerable:!1,writable:!0,configurable:!1,value:[]},updateServer:{enumerable:!1,writable:!0,configurable:!1,value:function(){var a=this,b=require("send"),c=require("http"),d=require("marked");d.setOptions({gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1});var e=require("fs").readFileSync(require("path").join("lib","public","directory.html"));this._http=c.createServer(function(c,f){function g(){a.syslog.log("Redirect to "+c.url+"/"),f.statusCode=301,f.setHeader("Location",c.url+"/"),f.end("Redirecting to "+c.url+"/")}function h(a){switch(a="."===a.substr(0,1)?a.substr(1,a.length-1):a,a.toLowerCase()){case"png":a="PNG Image";break;case"jpg":a="JPEG Image";break;case"svg":a="SVG Image";break;case"gif":a="GIF Image";break;case"ico":a="Windows Icon";break;case"txt":a="Text File";break;case"log":a="Log File";break;case"htm":a="HTML File";break;case"php":a="PHP Script";break;case"js":a="Javascript";break;case"css":a="Stylesheet";break;case"pdf":a="PDF Document";break;case"zip":a="ZIP Archive";break;case"bak":a="Backup File";break;default:a=a.toUpperCase()+" File"}return a}function i(b){var d=require("path").dirname(b.message.match(/'(.*?)'/)[1])||"",g=require("path").basename(b.message.match(/'(.*?)'/)[1])||"";if(b.message.indexOf("ENOENT")>=0&&"index.html"===g){var i="",j="";fs.readdir(d,function(a,b){i=b.filter(function(a){return require("fs").statSync(require("path").join(d,a)).isDirectory()}).map(function(a){var b=a+(require("fs").existsSync(require("path").join(d,"index.html"))?"/index.html":""),c=require("fs").statSync(require("path").join(d,a));return"<tr class='dir'><td><a href='./"+b+"'>"+a+"</a></td><td><a href='./"+b+"'>&lt;Directory&gt;</a></td><td><a href='./"+b+"'>&lt;Directory&gt;</a></td><td sorttable_customkey='"+c.mtime.getTime()+"'><a href='./"+b+"'>"+c.mtime+"</a></td></tr>"}),j=b.filter(function(a){return!require("fs").statSync(require("path").join(d,a)).isDirectory()}).map(function(a){var b="./"+a,c=require("path").extname(a),e=require("fs").statSync(require("path").join(d,a));return"<tr class='file'><td><a href='./"+b+"'>"+a+"</a></td><td><a href='./"+b+"'>"+h(c)+"</a></td><td><a href='./"+b+"'>"+(e.size/1024).toFixed(2)+" KB</a></td><td sorttable_customkey='"+e.mtime.getTime()+"'><a href='./"+b+"'>"+e.mtime+"</a></td></tr>"}),f.statusCode=200,f.end(e.toString().replace("<!-- BODY -->",i.join("")+j.join("")))})}else{if(c.url.indexOf("/fenixassets/")>=0){var k=require("path").resolve(require("path").join("lib",c.url.substr(c.url.indexOf("/fenixassets"),c.url.length).replace("fenixassets","public"))),l=require("path").extname(c.url).substr(1,require("path").extname(c.url).length-1);if("ico"===l)try{require("fs").readFile(require("path").resolve(require("path").join("lib",c.url.replace("fenixassets","icons"))),function(a,b){f.statusCode=200,f.end(b)})}catch(m){a.syslog.error("500 "+m.message),f.statusCode=500,f.end(m.message)}else if("fenix.png"===require("path").basename(c.url).toLowerCase())try{require("fs").readFile(require("path").resolve(require("path").join("lib",c.url.substr(c.url.indexOf("/fenixassets"),c.url.length).replace("fenixassets","icons"))),function(a,b){f.setHeader("Content-Type","image/png"),f.statusCode=200,f.end(b)})}catch(m){a.syslog.error("500 "+m.message),f.statusCode=500,f.end(m.message)}else if(require("fs").existsSync(k))try{require("fs").readFile(k,function(a,b){["css","html","js","htm"].indexOf(l)>=0&&f.setHeader("Content-Type",(["css","html"].indexOf(l)>=0?"text":"application")+"/"+("js"===l?"javascript":l)),f.statusCode=200,f.end(b)})}catch(m){a.syslog.error("500 "+m.message),f.statusCode=500,f.end(m.message)}else a.syslog.error("404 "+c.url),f.statusCode=404,f.end();return}a.syslog.error("("+(b.status||500).toString()+") "+b.message),f.statusCode=b.status||500,f.end(b.message)}}function j(b){require("fs").existsSync(b)||alert(b+" DNE");var c=require("path").extname(b).toLowerCase().replace(".","");if(a.syslog.log("Requested "+b),["json","xml"].indexOf(c)>=0)f.setHeader("Content-Type","application/"+c),f.setHeader("Transfer-Encoding","chunked"),f.setHeader("Access-Control-Allow-Headers","Content-Type");else if(["md","markdown"].indexOf(c)>=0){f.setHeader("Content-Type","text/html; charset=UTF-8"),f.setHeader("Transfer-Encoding","chunked"),f.setHeader("Access-Control-Allow-Headers","Content-Type");var e="<style>BODY{font-family:Arial,sans-serif;}</style>"+d(require("fs").readFileSync(b).toString());f.setHeader("Content-Length",e.length),a.syslog.log("Converted Markdown >> HTML"),f.end(e)}}b(c,require("url").parse(c.url).pathname).from(a.path).on("error",i).on("directory",g).on("file",j).pipe(f)}),this.http.on("connection",function(b){a.sockets.push(b),b.setTimeout(4e3),b.on("close",function(){a.sockets.splice(a.sockets.indexOf(b),1)})}),this.http.on("error",function(b){if(a.starting=a.running?a.starting:!1,"EACCES"!==b.code)throw b;a.emit("startfailure",b.code)})}},suppressed:{enumerable:!1,writable:!0,configurable:!1,value:!1},suppressnotices:{enumerable:!0,get:function(){return this.suppressed},set:function(a){this.suppressed="boolean"==typeof a?a:"true"===a?!0:!1}}});var b=this;require("getmac").getMac(function(a,c){if(a)throw a;b.MAC=c,b.computer=c,b.monitor(),b.cfg_paths&&(b.paths[b.MAC]=b.cfg_paths),b.initialized=!0,b.emit("initialized")}),this.on("error",function(a){b.syslog.error(a.message||"Unknown Error")})},share:function(){if(!this.shared&&!this.sharing){var a=this;this.sharing=!0,setTimeout(function(){a.shared||void 0!==c||(a.autoRestartTunnel=!1,a.sharing=!1,a.shared=!1,null!==a.tunnel&&(a.tunnel=null),a.emit("timeout"))},5e3);var b=require("localtunnel"),c=b(this.port,function(b,c){a.tunnel=c,a._url=c.url,a.shared=!0,a.sharing=!1,a.emit("share",a),c.once("close",function(){setTimeout(function(){a._url=null,a.shared=!1,a.sharing=!1,a.emit("unshare",a),a.syslog.warn("Stopped sharing server publicly.")},500)}),c.on("error",function(b){a.emit("error",b)})})}},unshare:function(a){return this.shared?(a&&this.tunnel.once("close",function(){setTimeout(function(){a&&a()},500)}),void this.tunnel.close()):void(a&&a())},captureScreen:function(a,b,c){var d=require("nw.gui"),e=this;if("function"==typeof a?(c=a,a=1024,b=a):"function"==typeof b&&(c=b,b=a),!this.running)return void c();var f=d.Window.open("http://127.0.0.1:"+this.port.toString(),{width:a,height:b,show:!1,toolbar:!1});setTimeout(function(){f.capturePage(function(a){e.screenshot=a,f.close(),c&&c()},{format:"png",datatype:"raw"})},4500)},monitor:function(){var a=require("watch"),b=this;a.createMonitor(require("path").resolve(this.path),function(a){a.on("created",function(a){b.running&&(b.emit("filecreated",{filename:a,server:b}),b.syslog.log(a+" created."))}),a.on("changed",function(a){b.running&&(b.emit("filechanged",{filename:a,server:b}),b.syslog.warn(a+" modified."))}),a.on("removed",function(a){b.running&&(b.emit("fileremoved",{filename:a,server:b}),b.syslog.log(a+" removed."))})})},start:function(a){var b=this;if(!this.starting){if(this.running)return void(a&&a());this.starting=!0,this.http.listen(this.port,function(){b.running=!0,b.starting=!1,b.emit("start",b),b.syslog.log("Server started on port "+b.port.toString()+"."),a&&a()})}},closeAllSockets:function(){this.sockets.forEach(function(a){a.destroy()})},stop:function(a){var b=this;if(this.starting=!1,!this.running)return b.emit("stop",b),void(a&&a());if(this.stopping=!0,this.shared){var c=setTimeout(function(){throw new Error("Server timed out while unsharing.")},3e3);this.once("unshare",function(){clearTimeout(c),b.http.once("close",function(){b.running=!1,b.stopping=!1,b.emit("stop",b),b.syslog.log("Server stopped on port "+b.port.toString()+"."),a&&a()}),b.http.close(),b.closeAllSockets()}),this.unshare()}else if(this.running)try{this.http.once("close",function(){b.running=!1,b.stopping=!1,b.emit("stop",b),b.syslog.log("Server stopped on port "+b.port.toString()+"."),a&&a()}),this.http.close(),this.closeAllSockets()}catch(d){if(console.dir(d),!(d.message.toLowerCase().indexOf("not running")>=0))throw d;a&&a()}else this.emit("stop",this),a&&a()}}),Router=Utility.extend({constructor:function(a){a=a||{},Router.super.constructor.call(this,a),Object.defineProperties(this,{proxy:{enumerable:!1,writable:!0,configurable:!1,value:null},running:{enumerable:!0,writable:!0,configurable:!1,value:!1},loading:{enumerable:!0,writable:!0,configurable:!1,value:!1},domainmap:{enumerable:!1,get:function(){var a={},b=this;return Object.keys(this.servers||{}).forEach(function(c){(b.servers[c].domain||"").trim().length>0&&(a[b.servers[c].domain]="127.0.0.1:"+b.servers[c].port.toString())}),a}},servers:{enumerable:!1,writable:!0,configurable:!1,value:{}},paths:{enumerable:!1,get:function(){var a={},b=this;return Object.keys(this.servers||{}).forEach(function(c){Object.defineProperty(a,b.servers[c].path,{enumerable:!1,get:function(){return b.servers[c]}})}),a}},ports:{enumerable:!1,get:function(){var a={},b=this;return Object.keys(this.servers||{}).forEach(function(c){Object.defineProperty(a,b.servers[c].port,{enumerable:!1,get:function(){return b.servers[c]}})}),a}},serverstore:{enumerable:!1,get:function(){var a=require("path");switch(process.platform.toLowerCase()){case"win32":return a.join(process.env.APPDATA,"Fenix","servers.fnx");case"darwin":return"/Users/Shared/Fenix.localized/servers.fnx";default:return a.resolve(a.join("./","servers.fnx"))}}},MAC:{enumerable:!1,writable:!0,configurable:!1,value:null},portscanner:{enumerable:!1,get:function(){return require("portscanner")}},_socket:{enumerable:!1,writable:!0,configurable:!1,value:null},socket:{enumerable:!1,get:function(){if(null==this._socket){var a=require("net"),b=this;this._socket=a.createServer(function(a){a.on("connection",function(a){a.on("connect",function(){console.log(a.address()),b.emit("socketconnect")})}),a.on("close",function(){b.emit("socketclose")})})}return this._socket}}});var b=this;require("getmac").getMac(function(a,c){if(a)throw a;b.MAC=c,b.computer=c}),this.socket.listen(336490,function(){b.emit("socketready")})},getServer:function(a){return this.servers[a]||null},createServer:function(a){return a=a||{},a.id=require("crypto").createHash("md5").update(a.path+(a.port||80).toString()).digest("hex"),this.servers[a.id]=new Server(a),this.save(),this.emit("createserver",this.servers[a.id]),this.servers[a.id]},deleteServer:function(a){var b=this;if(!this.servers.hasOwnProperty(a))throw new Error("Server "+a+" does not exist or could not be found.");this.servers[a].on("stop",function(){var c=b.servers[a];delete b.servers[a],b.save(),b.emit("deleteserver",c)}),this.servers[a].stop()},startAllWebServers:function(){var a=this;Object.keys(this.servers||{}).forEach(function(b){!a.servers[b].running&&a.servers[b].start()})},stopAllWebServers:function(){var a=this;Object.keys(this.servers||{}).forEach(function(b){a.servers[b].running&&a.servers[b].stop()})},getAvailablePort:function(a,b,c){if("function"!=typeof a)throw new Error("getAvailablePort must be given a callback method.");var d=this;b=b||80,c=c||1e4,this.portscanner.basePort=b,this.portscanner.findAPortNotInUse(b,c,"localhost",function(b,e){return b?(a(-1),void console.error(b.message)):void(d.ports.hasOwnProperty(e)?d.getAvailablePort(a,e+1,c):a(e))})},start:function(a,b){a=a||80,"function"==typeof a&&(b=a,a=80);var c=require("http-proxy");this.proxy=c.createServer({hostnameOnly:!0,router:this.domainmap}),this.proxy.listen(a,function(){me.emit("startproxy",this.proxy),b&&b()})},stop:function(a){this.proxy.close(),this.emit("stopproxy"),a&&a()},restart:function(a){var b=this;this.stop(function(){b.start(function(){a&&a()})})},save:function(){var a=this,b=[];Object.keys(this.servers).forEach(function(c){var d=a.servers[c].json;d.path=a.servers[c].path,d.running=a.servers[c].running,delete d.cfg_paths,delete d.screenshot,delete d.suppressnotices,d.port=parseInt(d.port),b.push(d)});var c=require("path").dirname(this.serverstore),d=require("fs"),e=require("path");d.existsSync(e.resolve(c))||d.mkdirSync(e.resolve(c)),d.writeFileSync(e.join(c,"servers.fnx"),JSON.stringify(b,null,2))},load:function(){var a=this;this.loading=!0;try{if(require("fs").existsSync(this.serverstore)){var b=JSON.parse(require("fs").readFileSync(this.serverstore));b.forEach(function(b){a.servers[b.id]=new Server({name:b.name,domain:b.domain,port:b.port,path:b.path,id:b.id}),b.running&&a.servers[b.id].start(),a.emit("loadserver",a.servers[b.id])})}}catch(c){alert(c.message)}this.loading=!1,this.emit("loadcomplete")}}),ROUTER=new Router,initServer=function(a){a.initialized?UI.server.display(a,function(){UI.loader.hide()}):(a.on("initialized",function(){document.getElementById(a.id)||UI.server.display(a,function(){UI.loader.hide()})}),a.on("error",function(b){console.dir(b),UI.notify({title:a.name,msg:(b.message||"Unknown Error")+" (Code: "+b.code.toString()+")"})}),a.off("startfailure").on("startfailure",function(){if(!a.assistingstart){if(ROUTER.loading)return void alert("Could not start "+a.name+". The user account has insufficient privileges to run a server on port "+a.port.toString());a.assistingstart=confirm("Insufficient user privileges.\nCannot run the server on port "+a.port.toString()+".\n\nSome systems require elevated permissions (sudo/admin) to run servers on certain ports. Would you like Fenix to automatically find and use a supported port to start the server on?"),a.assistingstart?(a.once("start",function(){a.assistingstart=!1}),ROUTER.getAvailablePort(function(b){a.port=b,UI.server.update(a.id),UI.server.unmask(),a.start()},1025)):UI.server.unmask()}}),a.on("screencapture",function(a){UI.server.setThumbnail(a.id,a.screenshot)}),a.on("share",function(){UI.server.share(a),!a.supressnotices&&UI.notify({title:a.name,text:"Publicy sharing server at "+a.publicUrl}),global.track.event("Web Server","share","Shared Web Server").send()}),a.on("unshare",function(){UI.server.unshare(a),!a.supressnotices&&UI.notify({title:a.name,text:"Stopped sharing server publicly"})}),a.on("start",function(){a.running&&(UI.server.start(a.id),a.captureScreen(),UI.server.unmask(a.id),!a.supressnotices&&UI.notify({title:a.name,text:"Started on port "+a.port.toString()}))}),a.on("stop",function(){a.running||(UI.server.stop(a.id),UI.server.unmask(a.id),!a.supressnotices&&UI.notify({title:a.name,text:"Stopped"}))}),a.on("filecreated",function(a){a.server.running&&"index.html"===a.filename.replace(a.server.path,"").replace("/","")&&setTimeout(function(){a.server.captureScreen()},1e3)}),a.on("filechanged",function(a){a.server.running&&"index.html"===a.filename.replace(a.server.path,"").replace("/","")&&setTimeout(function(){a.server.captureScreen()},1e3)}),a.on("fileremoved",function(a){a.server.running&&"index.html"===a.filename.replace(a.server.path,"").replace("/","")&&setTimeout(function(){a.server.captureScreen()},1e3)}),global.track.event("Web Server","create","Created Web Server").send())};ROUTER.on("createserver",function(a){UI.loader.show("Configuring the new server."),initServer(a)}),ROUTER.on("deleteserver",function(a){$("#"+a.id).addClass("bounceOut"),setTimeout(function(){$("#"+a.id).remove(),UI.notify({title:a.name,text:"Server Deleted"}),0===Object.keys(ROUTER.servers).length&&$("body").removeClass("hasservers")},1e3),global.track.event("Web Server","delete","Deleted Web Server").send()}),ROUTER.on("loadserver",function(a){initServer(a)}),ROUTER.on("loadcomplete",function(){require("request").get("https://api.github.com/repos/coreybutler/fenix/releases",{headers:{"user-agent":"Fenix"}},function(a,b,c){try{if(c){if(data=JSON.parse(c),data=(data||[])[0],void 0!==data){var d=require("semver"),e=require("./package.json").version;localStorage.setItem("updateavailable",d.lt(e,data.tag_name))}else localStorage.setItem("updateavailable",!1);setTimeout(function(){"true"===localStorage.getItem("updateavailable")&&(UI.updateAvailable(),UI.notify({title:"Update Available",text:"Version "+data.tag_name+" is available."})),global.windows.main.emit("ready")},2500+("true"===localStorage.getItem("updateavailable")?3e3:0))}else setTimeout(function(){global.windows.splash&&global.windows.splash.hide(),global.windows.main.show()},1500)}catch(f){alert("ERROR: "+f.message),global.windows.main.emit("ready"),winloaded=!0}})}),ROUTER.load(),$("#wizard > button").on("click",function(){UI.server.create({name:$("#wizard > #name").val(),port:parseInt($("#wizard > #port").val()),path:$("#wizard > #path").val()})}),$("#wizard > a").on("click",function(a){a.preventDefault(),UI.wizard.hide()}),ROUTER.getAvailablePort(function(a){$("#port").val(a)}),$("#filebrowser").on("click",function(a){a.preventDefault(),UI.wizard.browseFilepath()}),document.querySelector("#choosefile").addEventListener("change",function(){$("#path").val(this.value),UI.wizard.prepopulate(),UI.wizard.valid()&&UI.wizard.button.enable()},!1),$("#port").on("keypress",function(a){a=a?a:window.event;var b=a.which?a.which:a.keyCode;return b>31&&(48>b||b>57)?!1:!0});var fn=function(){UI.wizard.prepopulate()},delay=null;$("#path").on("keyup",function(){clearTimeout(delay),delay=setTimeout(fn,900)}),$("#wizard > input").on("keyup",function(){UI.wizard.valid()?UI.wizard.button.enable():UI.wizard.button.disable()}),$("#editwizard > button").on("click",function(a){var b=$(a.currentTarget.parentNode).find('input[type="hidden"]').val(),c=ROUTER.getServer(b),d=c.running,e=c.shared;c.suppressnotices=!0,c.stop(function(){c.path!==$("#epath").val()&&c.syslog.log("Path changed from "+c.path+" to "+$("#epath").val()),c.name!==$("#ename").val()&&c.syslog.log("Name changed from "+c.name+" to "+$("#ename").val()),c.port!==parseInt($("#eport").val())&&c.syslog.log("Path changed from "+c.port.toString()+" to "+$("#eport").val().toString()),c.path=$("#epath").val(),c.port=$("#eport").val(),c.name=$("#ename").val(),UI.server.update(b),require("fs").existsSync(c.path)?d?(c.once("start",function(){e&&c.share(),c.suppressnotices=!1,UI.notify({title:"Server Modified",text:c.name+" was modified and restarted. Now running "+c.path+" on port "+c.port.toString()})}),c.start(),ROUTER.save()):c.suppressnotices=!0:($("#"+b).addClass("unavailable"),c.suppressnotices=!1),UI.editwizard.hide()})}),$("#editwizard > a").on("click",function(a){a.preventDefault(),UI.editwizard.hide()}),$("#filebrowser2").on("click",function(a){a.preventDefault(),UI.editwizard.browseFilepath()}),document.querySelector("#choosefile2").addEventListener("change",function(){$("#epath").val(this.value),UI.editwizard.prepopulate()
},!1),$("#eport").on("keypress",function(a){a=a?a:window.event;var b=a.which?a.which:a.keyCode;return b>31&&(48>b||b>57)?!1:!0});var efn=function(){UI.editwizard.prepopulate()},edelay=null;$("#epath").on("keyup",function(){clearTimeout(edelay),edelay=setTimeout(efn,900)}),$("#editwizard > input").on("keyup",function(){UI.editwizard.valid()?UI.editwizard.button.enable():UI.editwizard.button.disable()});var express=require("express"),api=express(),fs=require("fs");api.use(express.json()),api.use(express.urlencoded()),api.use(function(a,b,c){b.set({"x-powered-by":"Fenix"}),c()}),api.get("/server/list",function(a,b){b.json(Object.keys(ROUTER.servers).map(function(a){var b=ROUTER.getServer(a),c=b.json;return c.running=b.running,c.shared=b.shared,c.shared&&(c.publicUrl=b.publicUrl),delete c.screenshot,delete c.cfg_paths,delete c.suppressnotices,c}))}),api.put("/server/:server/stop",function(a,b){var c=ROUTER.getServer(a.params.server);return c||(c=ROUTER.getServer(Object.keys(ROUTER.servers).filter(function(b){var c=ROUTER.getServer(b);return c.name.trim().toLowerCase()===a.params.server.trim().toLowerCase()?!0:c.path.trim().toLowerCase()===a.params.server.trim().toLowerCase()?!0:c.port===parseInt(a.params.server)?!0:!1})[0])),c?c.running?void c.stop(function(){b.send(200)}):void b.send(200):void b.send(404)}),api.put("/server/:server/start",function(a,b){var c=ROUTER.getServer(a.params.server);if(c||(c=ROUTER.getServer(Object.keys(ROUTER.servers).filter(function(b){var c=ROUTER.getServer(b);return c.name.trim().toLowerCase()===a.params.server.trim().toLowerCase()?!0:c.path.trim().toLowerCase()===a.params.server.trim().toLowerCase()?!0:c.port===parseInt(a.params.server)?!0:!1})[0])),!c)return void b.send(404);if(c.running){var d=c.json;return delete d.screenshot,delete d.cfg_paths,delete d.suppressnotices,d.shared=c.shared,d.publicUrl=c.publicUrl||null,void b.json(d)}require("fs").existsSync(c.path)||b.send(410),ROUTER.portscanner.checkPortStatus(c.port,"127.0.0.1",function(a,d){return"open"===d?void b.send(409):void c.start(function(){var a=c.json;delete a.screenshot,delete a.cfg_paths,delete a.suppressnotices,a.shared=c.shared,a.publicUrl=c.publicUrl||null,b.json(a)})})}),api.put("/server/:server/share",function(a,b){var c=ROUTER.getServer(a.params.server);if(c||(c=ROUTER.getServer(Object.keys(ROUTER.servers).filter(function(b){var c=ROUTER.getServer(b);return c.name.trim().toLowerCase()===a.params.server.trim().toLowerCase()?!0:c.path.trim().toLowerCase()===a.params.server.trim().toLowerCase()?!0:c.port===parseInt(a.params.server)?!0:!1})[0])),!c)return void b.send(404);var d=c.json;return delete d.screenshot,delete d.cfg_paths,delete d.suppressnotices,c.shared?(d.publicUrl=c.publicUrl,void b.json(d)):void(c.running?(c.on("share",function(){d.publicUrl=c.publicUrl,b.json(d)}),c.share()):ROUTER.portscanner.checkPortStatus(c.port,"127.0.0.1",function(a,e){return"open"===e?void b.send(409):void c.start(function(){c.once("share",function(){d.publicUrl=c.publicUrl,b.json(d)}),setTimeout(function(){c.share()},500)})}))}),api.put("/server/:server/unshare",function(a,b){var c=ROUTER.getServer(a.params.server);return c||(c=ROUTER.getServer(Object.keys(ROUTER.servers).filter(function(b){var c=ROUTER.getServer(b);return c.name.trim().toLowerCase()===a.params.server.trim().toLowerCase()?!0:c.path.trim().toLowerCase()===a.params.server.trim().toLowerCase()?!0:c.port===parseInt(a.params.server)?!0:!1})[0])),c?c.shared?void c.unshare(function(){b.send(200)}):void b.send(200):void b.send(404)}),api.put("/server/:server/status",function(a,b){var c=ROUTER.getServer(a.params.server);if(c||(c=ROUTER.getServer(Object.keys(ROUTER.servers).filter(function(b){var c=ROUTER.getServer(b);return c.name.trim().toLowerCase()===a.params.server.trim().toLowerCase()?!0:c.path.trim().toLowerCase()===a.params.server.trim().toLowerCase()?!0:c.port===parseInt(a.params.server)?!0:!1})[0])),!c)return void b.send(404);var d=c.json;delete d.screenshot,delete d.cfg_paths,delete d.suppressnotices,d.shared=c.shared,d.publicUrl=c.publicUrl||null,b.json(d)}),api.get("/server/:server/list",function(a,b){var c=Object.keys(ROUTER.servers).filter(function(b){var c=ROUTER.getServer(b);return isNaN(parseInt(a.params.server))?c.name.trim().toLowerCase()===a.params.server.trim().toLowerCase():parseInt(a.params.server)===c.port}).map(function(a){var b=ROUTER.getServer(a),c=b.json;return c.running=b.running,c.shared=b.shared,c.shared&&(c.publicUrl=b.publicUrl),delete c.screenshot,delete c.cfg_paths,delete c.suppressnotices,c})[0];void 0===c?b.send(404):b.json(c)}),api.post("/server",function(a,b){return a.body.hasOwnProperty("path")&&a.body.hasOwnProperty("name")?void ROUTER.getAvailablePort(function(c){var d=ROUTER.createServer({name:a.body.name,path:a.body.path,port:c});return fs.existsSync(a.body.path)?(d.on("start",function(){setTimeout(function(){var a=d.json;a.running=d.running,a.shared=d.shared,a.shared&&(a.publicUrl=d.publicUrl),delete a.screenshot,delete a.cfg_paths,delete a.suppressnotices,b.send(a)},1500)}),void d.start()):void b.send(201)},parseInt(a.body.port)||80):void b.send(400)}),api.del("/server/:server",function(a,b){var c=Object.keys(ROUTER.servers).filter(function(b){var c=ROUTER.getServer(b);return isNaN(parseInt(a.params.server))?a.params.server===c.path?!0:c.name.trim().toLowerCase()===a.params.server.trim().toLowerCase():parseInt(a.params.server)===c.port}).map(function(a){var b=ROUTER.getServer(a),c=b.json;return c.running=b.running,c.shared=b.shared,c.shared&&(c.publicUrl=b.publicUrl),delete c.screenshot,delete c.cfg_paths,delete c.suppressnotices,c})[0];void 0===c?b.send(404):(ROUTER.on("deleteserver",function(a){(a.id=c.id)&&b.send(200)}),ROUTER.deleteServer(c.id))}),api.put("/close",function(a,b){setTimeout(function(){var a=require("nw.gui");a.Window.get(this).close()},500),b.send(200)}),api.get("/version",function(a,b){b.send(global.pkg.version)}),api.listen(33649,function(){console.log("Console server available on port 33649")});var gui=require("nw.gui");$("nav > li > ul > li").click(function(e){e.preventDefault(),$("nav > li > ul").addClass("hide"),setTimeout(function(){$("nav > li > ul").removeClass("hide")},300),eval($(e.currentTarget).find("a")[0].href.replace("javascript:",""))}),$("nav > li > ul > li > a").click(function(){$("nav > li > ul").addClass("hide"),setTimeout(function(){$("nav > li > ul").removeClass("hide")},300)}),"darwin"===process.platform&&($("nav").css("background-color","#B1B1B1"),$("nav").css("display","flex"),$("nav").css("font-weight","bold"),global.windows.main.on("blur",function(){$("nav").css("background-color","#E1E1E1")}),global.windows.main.on("focus",function(){$("nav").css("background-color","#B1B1B1")})),binopened=!1;var openRequestBin=function(){global.track.event("Application","webhooks","Opened Webhooks").send(),global.track.pageview("/app/webhooks/open").send(),!binopened&&global.windows.bin.emit("autoshare"),global.windows.bin.show(),global.windows.bin.focus(),binopened=!0},openAbout=function(){global.track.event("Application","help","Opened Help").send(),global.track.pageview("/app/help/open").send(),global.windows.about.show(),global.windows.about.focus()};global.windows.main.on("close",function(){ROUTER.save()}),"darwin"===process.platform&&global.windows.main.setShowInTaskbar(!0),$(window).on("keyup",function(a){192===a.keyCode&&a.ctrlKey&&a.shiftKey&&(global.windows.main.showDevTools(),global.windows.head.showDevTools())});